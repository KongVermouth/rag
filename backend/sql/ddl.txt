-- 创建数据库
CREATE DATABASE IF NOT EXISTS rag_system DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE rag_system;

-- ============================================
-- 1. 用户表 (rag_user)
-- ============================================
CREATE TABLE `rag_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希',
  `password_changed_at` DATETIME NULL COMMENT '密码最后修改时间',
  `avatar_url` VARCHAR(255) DEFAULT NULL COMMENT '头像地址',
  `role` VARCHAR(20) DEFAULT 'user' COMMENT '角色: admin, user',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0=禁用, 1=正常',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';


-- ============================================
-- 2. 大模型表 (rag_llm)
-- ============================================
CREATE TABLE `rag_llm` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '模型ID',
  `user_id` BIGINT NOT NULL COMMENT '创建者用户ID',
  `name` VARCHAR(100) NOT NULL COMMENT '模型显示名称',
  `provider` VARCHAR(50) NOT NULL COMMENT '提供商: openai, azure, anthropic, qwen',
  `model_name` VARCHAR(100) NOT NULL COMMENT '模型名称: gpt-4, text-embedding-3-small',
  `base_url` VARCHAR(255) DEFAULT NULL COMMENT 'API Endpoint (非标准地址)',
  `api_version` VARCHAR(50) NULL COMMENT 'API版本',
  `model_type` VARCHAR(20) NOT NULL COMMENT '类型: chat(对话), embedding(向量化), rerank(重排)',
  `max_tokens` INT DEFAULT 4096 COMMENT '最大上下文Token数',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '模型描述',
  `status` INT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='大模型定义表';


-- ============================================
-- 3. 大模型 API Key 表 (rag_apikey)
-- 注意：user_id 和 llm_id 不设置外键约束，由应用层保证数据一致性
-- ============================================
CREATE TABLE `rag_apikey` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'Key ID',
  `user_id` BIGINT NOT NULL COMMENT '创建者用户ID',
  `llm_id` BIGINT NOT NULL COMMENT '关联的模型ID',
  `api_key_encrypted` TEXT NOT NULL COMMENT '加密后的API Key',
  `alias` VARCHAR(100) NOT NULL COMMENT 'Key别名/名称',
  `description` VARCHAR(500) NULL COMMENT '密钥描述',
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0=失效, 1=正常',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_apikey_llm` (`llm_id`),
  KEY `idx_apikey_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='模型API Key管理表';


-- ============================================
-- 4. 知识库表 (rag_knowledge)
-- ============================================
CREATE TABLE `rag_knowledge` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '知识库ID',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',
  `name` VARCHAR(100) NOT NULL COMMENT '知识库名称',
  `description` VARCHAR(500) DEFAULT NULL COMMENT '描述',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '知识库图标',
  `embed_llm_id` BIGINT NOT NULL COMMENT '使用的Embedding模型ID',
  `vector_collection_name` VARCHAR(100) NOT NULL COMMENT '向量数据库集合名称',
  
  -- 向量化配置
  `chunk_size` INT DEFAULT 500 COMMENT '切片大小',
  `chunk_overlap` INT DEFAULT 50 COMMENT '切片重叠大小',
  
  -- 统计信息
  `document count` INT DEFAULT 0 COMMENT '文档数量',
  `total_chunks` INT DEFAULT 0 COMMENT '总切片数',
  
  `status` INT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识库表';

-- ============================================
-- 5. 文档表 (rag_document)
-- ============================================
CREATE TABLE `rag_document` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '文档ID',
  `knowledge_id` BIGINT NOT NULL COMMENT '所属知识库ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '原始文件名',
  `file_path` VARCHAR(500) NOT NULL COMMENT '文件存储路径/OSS地址',
  `file_extension` VARCHAR(20) NOT NULL COMMENT '文件后缀',
  `file_size` BIGINT DEFAULT 0 COMMENT '文件大小(字节)',
  
  -- 处理状态
  `status` VARCHAR(20) DEFAULT 'uploading' COMMENT '状态: uploading, parsing, embedding, completed, failed',
  `chunk_count` INT DEFAULT 0 COMMENT '生成的切片数量',
  `error_msg` TEXT DEFAULT NULL COMMENT '失败时的错误信息',
  
  `meta_data` JSON DEFAULT NULL COMMENT '文档元数据',
  
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_knowledge` (`knowledge_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文档表';

-- ============================================
-- 6. 问答机器人表 (rag_robot)
-- ============================================
CREATE TABLE `rag_robot` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '机器人ID',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',
  `name` VARCHAR(100) NOT NULL COMMENT '机器人名称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '机器人头像',
  `llm_id` BIGINT NOT NULL COMMENT '使用的对话模型ID',
  
  -- 提示词配置
  `system_prompt` TEXT DEFAULT NULL COMMENT '系统提示词',
  `welcome_msg` VARCHAR(500) DEFAULT NULL COMMENT '欢迎语',
  `suggested_questions` JSON DEFAULT NULL COMMENT '推荐问题',
  
  -- 检索配置 (RAG参数)
  `similarity_threshold` FLOAT DEFAULT 0.6 COMMENT '相似度阈值',
  `top_k` INT DEFAULT 5 COMMENT '召回切片数量',
  
  `status` TINYINT DEFAULT 1 COMMENT '状态: 0=下线, 1=上线',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='问答机器人配置表';

-- ============================================
-- 7. 机器人-知识库关联表 (rag_robot_knowledge)
-- 多对多关系，无外键
-- ============================================
CREATE TABLE `rag_robot_knowledge` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `robot_id` BIGINT NOT NULL COMMENT '机器人ID',
  `knowledge_id` BIGINT NOT NULL COMMENT '知识库ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '关联时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_robot_kb` (`robot_id`, `knowledge_id`),
  KEY `idx_kb` (`knowledge_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='机器人知识库关联表';

-- ============================================
-- 8. 用户会话表 (rag_session)
-- 存储用户与机器人的会话元数据
-- ============================================
CREATE TABLE `rag_session` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '会话ID',
  `session_id` VARCHAR(64) NOT NULL COMMENT '会话UUID（用于API交互）',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',
  `robot_id` BIGINT NOT NULL COMMENT '关联的机器人ID',
  
  -- 会话元数据
  `title` VARCHAR(200) DEFAULT NULL COMMENT '会话标题（可自动生成或用户自定义）',
  `summary` VARCHAR(500) DEFAULT NULL COMMENT '会话摘要',
  `message_count` INT DEFAULT 0 COMMENT '消息数量（问答对数量）',
  
  -- 会话状态
  `status` VARCHAR(20) DEFAULT 'active' COMMENT '状态: active=活跃, archived=已归档, deleted=已删除',
  `is_pinned` TINYINT DEFAULT 0 COMMENT '是否置顶: 0=否, 1=是',
  
  -- 时间戳
  `last_message_at` DATETIME DEFAULT NULL COMMENT '最后一条消息时间',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  -- 额外元数据（JSON格式存储扩展信息）
  `meta_data` JSON DEFAULT NULL COMMENT '扩展元数据（如：客户端信息、标签等）',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_session_id` (`session_id`),
  KEY `idx_user_robot` (`user_id`, `robot_id`),
  KEY `idx_user_status` (`user_id`, `status`),
  KEY `idx_last_message` (`last_message_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户会话表';

-- ============================================
-- 9. 用户历史问答记录表 (rag_chat_history)
-- 持久化存储所有对话历史
-- ============================================
CREATE TABLE `rag_chat_history` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `session_id` VARCHAR(64) NOT NULL COMMENT '所属会话UUID',
  `message_id` VARCHAR(64) NOT NULL COMMENT '消息UUID（唯一标识每条消息）',
  
  -- 消息内容
  `role` VARCHAR(20) NOT NULL COMMENT '角色: user=用户, assistant=助手, system=系统',
  `content` TEXT NOT NULL COMMENT '消息内容',
  
  -- 关联信息（仅assistant角色）
  `retrieved_contexts` JSON DEFAULT NULL COMMENT '检索到的上下文（JSON数组）',
  `referenced_doc_ids` JSON DEFAULT NULL COMMENT '引用的文档ID列表',
  
  -- Token统计（仅assistant角色）
  `prompt_tokens` INT DEFAULT 0 COMMENT 'Prompt Token数',
  `completion_tokens` INT DEFAULT 0 COMMENT '回答 Token数',
  `total_tokens` INT DEFAULT 0 COMMENT '总Token数',
  
  -- 性能指标
  `retrieval_time_ms` INT DEFAULT 0 COMMENT '检索耗时(毫秒)',
  `generation_time_ms` INT DEFAULT 0 COMMENT '生成耗时(毫秒)',
  `total_time_ms` INT DEFAULT 0 COMMENT '总耗时(毫秒)',
  
  -- 用户反馈
  `feedback` TINYINT DEFAULT NULL COMMENT '用户反馈: 1=有用, -1=无用, NULL=未反馈',
  `feedback_comment` VARCHAR(500) DEFAULT NULL COMMENT '反馈评论',
  
  -- 序号与时间
  `sequence` INT NOT NULL COMMENT '消息在会话中的序号（从1开始）',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  
  -- 额外元数据
  `meta_data` JSON DEFAULT NULL COMMENT '扩展元数据',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_message_id` (`message_id`),
  KEY `idx_session` (`session_id`),
  KEY `idx_session_seq` (`session_id`, `sequence`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户历史问答记录表';
